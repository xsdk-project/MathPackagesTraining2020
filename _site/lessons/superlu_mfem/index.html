<!doctype html>
<html class="no-js" lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Sparse, Direct Solvers</title>

    <link rel="stylesheet" type="text/css" href="http://localhost:4000/assets/css/styles_feeling_responsive.css">

  

	<script src="http://localhost:4000/assets/js/modernizr.min.js"></script>

	<script src="https://ajax.googleapis.com/ajax/libs/webfont/1.5.18/webfont.js"></script>
	<script>
		WebFont.load({
			google: {
				families: [ 'Lato:400,700,400italic:latin', 'Volkhov::latin' ]
			}
		});
	</script>

	<noscript>
		<link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic%7CVolkhov' rel='stylesheet' type='text/css'>
	</noscript>


	<!-- Search Engine Optimization -->
	<meta name="description" content="At A Glance


  
    
      Questions
      Objectives
      Key Points
    
    
      1. Why use a direct solver?
      Understand accuracy
      Direct solvers are robustfor difficult problems
    
    
      2. What effects direct solve performance ?
      Understand ordering options
      Time &amp;amp; space performancecan vary a lot.
    
  


To begin this lesson


  Open the Answers Form
  Get into the correct directory
    cd HandsOnLessons/superlu_mfem
    
    The problem being solved
  


The convdiff.c
application is modeling the steady state convection-diffusion equation in 2D
with a constant velocity.  This equation is used to model the concentration
of something like a die in a moving fluid as it diffuses and flows through
he fluid.  The equation is as follows:



Where u is the concentration that we are tracking, , is the diffusion rate,
v is the velocity of the flow and R is a concentration source.

In the application we use here, the velocity vector direction is fixed in the +x
direction. However, the magnitude is set by the user (default of 100), ,
is fixed at 1.0, and the source is 0.0 everywhere except for a small square centered at
the middle of the domain where it is 1.0.


  
    
      Initial Condition
    
  
  
    
      
    
  


Solving this PDE is well known to cause convergence problems for iterative solvers,
for larger v. We use MFEM as a vehicle to demonstrate the use of a distributed,
direct solver, SuperLU_DIST,
to solve very ill-conditioned linear systems.

Running the Example

Run 1: default setting with GMRES solver, preconditioned by hypre, velocity = 100

$ ./convdiff | tail -n 3
Time required for first solve:  0.0408995 (s)
Final L2 norm of residual: 2.43686e-16



  
    
      Steady State
    
  
  
    
      
    
  




Run 2: increase velocity to 1000, GMRES does not converge anymore

$ ./convdiff --velocity 1000 | tail -n 3
Time required for first solve:  0.47337 (s)
Final L2 norm of residual: 0.00095



  
  
  How many orders of magnitude different is L2 norm of the residual as compared to the previous run?

  
    
    
      
          Between 12 and 13

      
    
  


Below, we plot behavior of the GMRES method for velocity values in the
range [100,1000] at increments, dv, of 25 and also show an animation
of the solution GMRES gives as velocity increases


  
    
      Solutions @dv=25 in [100,1000]
      Contours of Solution @ vel=1000
    
  
  
    
      
      
    
  



  
    
      Time to Solution
      L2 norm of final residual
    
  
  
    
      
      
    
  



  
  
  What do you think happened?

  
    
    
      
          GMRES method works ok for low velocity values.
           As velocity increases, GMRES method eventually crosses a
           threshold where it can no longer provide a useful result

      
    
  



  
  
  Why does time to solution show smoother transition than L2 norm?

  
    
    
      
          As instability is approached, more GMRES iterations are required to
           reach desired norm. So GMRES is still able to manage the solve and
           achieve a near-zero L2 norm. It just takes more and more iterations.
           Once GMRES is unable to solve the L2 norm explodes.

      
    
  




Run 3: Now use SuperLU_DIST, with “natural ordering”
$  ./convdiff --velocity 1000 -slu -cp 0  
Options used:
   --refine 0
   --order 1
   --velocity 1000
   --no-visit
   --superlu
   --slu-colperm 0
   --slu-rowperm 1
   --slu-parsymbfact 0
   --one-matrix
   --one-rhs
Number of unknowns: 10201
	Nonzeros in L       1040781
	Nonzeros in U       1045632
	nonzeros in L+U     2076212
	nonzeros in LSUB    1040215

** Memory Usage **********************************
** NUMfact space (MB): (sum-of-all-processes)
    L\U :           41.12 |  Total :    50.74
** Total highmark (MB):
    Sum-of-all :    50.74 | Avg :    50.74  | Max :    50.74
**************************************************
Time required for first solve:  19.0018 (s)
Final L2 norm of residual: 1.62703e-18

**************************************************
**** Time (seconds) ****
	EQUIL time             0.00
	ROWPERM time           0.01
	SYMBFACT time          0.04
	DISTRIBUTE time        0.11
	FACTOR time           18.52
	Factor flops	1.958603e+08	Mflops 	   10.58
	SOLVE time             0.10
	Solve flops	5.167045e+06	Mflops 	   52.21
	REFINEMENT time        0.20	Steps       2

**************************************************



  
    
      Stead State For vel=1000
    
  
  
    
      
    
  


Run 4: Now use SuperLU_DIST, with MMD(A’+A) ordering.
$ ./convdiff --velocity 1000 -slu -cp 2
Options used:
   --refine 0
   --order 1
   --velocity 1000
   --no-visit
   --superlu
   --slu-colperm 2
   --slu-rowperm 1
   --slu-parsymbfact 0
   --one-matrix
   --one-rhs
Number of unknowns: 10201
	Nonzeros in L       594238
	Nonzeros in U       580425
	nonzeros in L+U     1164462
	nonzeros in LSUB    203857

** Memory Usage **********************************
** NUMfact space (MB): (sum-of-all-processes)
    L\U :           10.07 |  Total :    15.52
** Total highmark (MB):
    Sum-of-all :    15.52 | Avg :    15.52  | Max :    15.52
**************************************************
Time required for first solve:  0.111105 (s)
Final L2 norm of residual: 1.53726e-18

**************************************************
**** Time (seconds) ****
	EQUIL time             0.00
	ROWPERM time           0.01
	COLPERM time           0.04
	SYMBFACT time          0.01
	DISTRIBUTE time        0.02
	FACTOR time            0.05
	Factor flops	1.063303e+08	Mflops 	 2045.75
	SOLVE time             0.00
	Solve flops	2.367059e+06	Mflops 	  779.35
	REFINEMENT time        0.01	Steps       2

**************************************************

NOTE: the number of nonzeros in L+U is much smaller than natural ordering.
This affects the memory usage and runtime.

Run 5: Now use SuperLU_DIST, with Metis(A’+A) ordering.
$ ./convdiff --velocity 1000 -slu -cp 4
Options used:
   --refine 0
   --order 1
   --velocity 1000
   --no-visit
   --superlu
   --slu-colperm 4
   --slu-rowperm 1
   --slu-parsymbfact 0
   --one-matrix
   --one-rhs
Number of unknowns: 10201
	Nonzeros in L       522306
	Nonzeros in U       527748
	nonzeros in L+U     1039853
	nonzeros in LSUB    218211

** Memory Usage **********************************
** NUMfact space (MB): (sum-of-all-processes)
    L\U :            9.24 |  Total :    14.96
** Total highmark (MB):
    Sum-of-all :    14.96 | Avg :    14.96  | Max :    14.96
**************************************************
Time required for first solve:  0.152424 (s)
Final L2 norm of residual: 1.51089e-18

**************************************************
**** Time (seconds) ****
	EQUIL time             0.00
	ROWPERM time           0.01
	COLPERM time           0.05
	SYMBFACT time          0.01
	DISTRIBUTE time        0.02
	FACTOR time            0.05
	Factor flops	7.827314e+07	Mflops 	 1717.18
	SOLVE time             0.00
	Solve flops	2.120276e+06	Mflops 	  606.75
	REFINEMENT time        0.01	Steps       2

**************************************************



  
    
      Solutions @dv=25 in [100,1000]
      Steady State Solution @ vel=1000
    
  
  
    
      
      
    
  


Run 5.5: Now use SuperLU_DIST, with Metis(A’+A) ordering, using 1 MPI tasks, on a larger problem.
By adding --refine 3, each element in the mesh is subdivided twice yielding a 64x larger problem.
But, we’ll run it on only one processor.

$ mpiexec -n 1 ./convdiff --refine 3 --velocity 1000 -slu -cp 4
Options used:
   --refine 3
   --order 1
   --velocity 1000
   --no-visit
   --superlu
   --slu-colperm 4
   --slu-rowperm 1
   --slu-parsymbfact 0
   --one-matrix
   --one-rhs
Number of unknowns: 641601
	Nonzeros in L       40412796
	Nonzeros in U       40412796
	nonzeros in L+U     80183991
	nonzeros in LSUB    15748820

** Memory Usage **********************************
** NUMfact space (MB): (sum-of-all-processes)
    L\U :          701.82 |  Total :   758.92
** Total highmark (MB):
    Sum-of-all :   786.78 | Avg :   786.78  | Max :   786.78
**************************************************
Time required for first solve:  18.8951 (s)
Final L2 norm of residual: 5.99013e-18

**************************************************
**** Time (seconds) ****
	EQUIL time             0.03
	ROWPERM time           0.29
	COLPERM time           4.83
	SYMBFACT time          0.32
	DISTRIBUTE time        1.58
	FACTOR time            9.87
	Factor flops	2.326266e+10	Mflops 	 2357.24
	SOLVE time             0.41
	Solve flops	1.604473e+08	Mflops 	  395.95
	REFINEMENT time        0.90	Steps       2
**************************************************


Run 6: Now use SuperLU_DIST, with Metis(A’+A) ordering, using 16 MPI tasks, on a larger problem.

Here, we’ll re-run the above except on 16 tasks and just grep the output form some key values of interest.

$ ${MPIEXEC_OMPI} -n 16 ./convdiff --refine 3 --velocity 1000 -slu --slu-colperm 4 &amp;gt;&amp;amp; run6.out
Options used:
   --refine 3
   --order 1
   --velocity 1000
   --no-visit
   --superlu
   --slu-colperm 4
   --slu-rowperm 1
   --slu-parsymbfact 0
   --one-matrix
   --one-rhs
Number of unknowns: 641601
	Nonzeros in L       40340620
	Nonzeros in U       40340620
	nonzeros in L+U     80039639
	nonzeros in LSUB    15901421

** Memory Usage **********************************
** NUMfact space (MB): (sum-of-all-processes)
    L\U :          705.31 |  Total :   974.93
** Total highmark (MB):
    Sum-of-all :  2888.58 | Avg :   180.54  | Max :   180.54
**************************************************
Time required for first solve:  9.10544 (s)
Final L2 norm of residual: 2.29801e-39

**************************************************
**** Time (seconds) ****
	EQUIL time             0.03
	ROWPERM time           0.36
	COLPERM time           5.57
	SYMBFACT time          0.37
	DISTRIBUTE time        0.30
	FACTOR time            1.62
	Factor flops	2.301228e+10	Mflops 	14226.55
	SOLVE time             0.14
	Solve flops	1.623936e+08	Mflops 	 1148.60
	REFINEMENT time        0.30	Steps       2



  
  
  Can you explain the processor times relative to
              the previous, single processor run?

  
    
    
      
          We have increased the mesh size by 8x here. The matrix dimension
            goes up as the SQUARE of the mesh size and this accounts for 64x factor
	    of DOFs. We have
            also added 16x processors. The parallel runtime is 9.10544 seconds.

      
    
  


Run 7: Now use SuperLU_DIST, solve the systems with same A, but different right-hand side b.
Here, we solve a different linear system but with the same coefficient matrix A. We tell  SuperLU to re-use the exisiting LU factors, but only give a different right-hand side.
Notice the improvement in solve time when re-using the factors.

$ mpiexec -n 16 ./convdiff --refine 3 --velocity 1000 -slu -cp 4 -2rhs
Options used:
   --refine 3
   --order 1
   --velocity 1000
   --no-visit
   --superlu
   --slu-colperm 4
   --slu-rowperm 1
   --slu-parsymbfact 0
   --one-matrix
   --two-rhs
Number of unknowns: 641601
	Nonzeros in L       40340620
	Nonzeros in U       40340620
	nonzeros in L+U     80039639
	nonzeros in LSUB    15901421

** Memory Usage **********************************
** NUMfact space (MB): (sum-of-all-processes)
    L\U :          705.31 |  Total :   974.93
** Total highmark (MB):
    Sum-of-all :  2888.58 | Avg :   180.54  | Max :   180.54
**************************************************
Time required for first solve:  9.11672 (s)
Final L2 norm of residual: 2.14235e-39

**************************************************
**** Time (seconds) ****
	EQUIL time             0.04
	ROWPERM time           0.36
	COLPERM time           5.64
	SYMBFACT time          0.38
	DISTRIBUTE time        0.23
	FACTOR time            1.61
	Factor flops	2.301228e+10	Mflops 	14307.11
	SOLVE time             0.14
	Solve flops	1.623936e+08	Mflops 	 1147.81
	REFINEMENT time        0.30	Steps       2

**************************************************
Time required for second solve (new rhs):  0.46439 (s)
Final L2 norm of residual: 1.95236e-39

	SOLVE time             0.14
	Solve flops	1.623936e+08	Mflops 	 1202.77
	REFINEMENT time        0.29	Steps       2

**************************************************




Out-Brief

In this lesson, we have used MFEM as a vehicle to demonstrate
the value of direct solvers from the SuperLU_DIST
numerical package.

Further Reading

To learn more about sparse direct solver, see Gene Golub SIAM Summer School
course materials:
Lecture Notes,
Book Chapter, and
Video">
	<meta name="google-site-verification" content="Vk0IOJ2jwG_qEoG7fuEXYqv0m2rLa8P778Fi_GrsgEQ">
	<meta name="msvalidate.01" content="0FB4C028ABCF07C908C54386ABD2D97F" >
	
	<link rel="author" href="https://plus.google.com/u/0/118311555303973066167">
	
	
	<link rel="canonical" href="http://localhost:4000/lessons/superlu_mfem/">


	<!-- Facebook Open Graph -->
	<meta property="og:title" content="Sparse, Direct Solvers">
	<meta property="og:description" content="At A Glance


  
    
      Questions
      Objectives
      Key Points
    
    
      1. Why use a direct solver?
      Understand accuracy
      Direct solvers are robustfor difficult problems
    
    
      2. What effects direct solve performance ?
      Understand ordering options
      Time &amp;amp; space performancecan vary a lot.
    
  


To begin this lesson


  Open the Answers Form
  Get into the correct directory
    cd HandsOnLessons/superlu_mfem
    
    The problem being solved
  


The convdiff.c
application is modeling the steady state convection-diffusion equation in 2D
with a constant velocity.  This equation is used to model the concentration
of something like a die in a moving fluid as it diffuses and flows through
he fluid.  The equation is as follows:



Where u is the concentration that we are tracking, , is the diffusion rate,
v is the velocity of the flow and R is a concentration source.

In the application we use here, the velocity vector direction is fixed in the +x
direction. However, the magnitude is set by the user (default of 100), ,
is fixed at 1.0, and the source is 0.0 everywhere except for a small square centered at
the middle of the domain where it is 1.0.


  
    
      Initial Condition
    
  
  
    
      
    
  


Solving this PDE is well known to cause convergence problems for iterative solvers,
for larger v. We use MFEM as a vehicle to demonstrate the use of a distributed,
direct solver, SuperLU_DIST,
to solve very ill-conditioned linear systems.

Running the Example

Run 1: default setting with GMRES solver, preconditioned by hypre, velocity = 100

$ ./convdiff | tail -n 3
Time required for first solve:  0.0408995 (s)
Final L2 norm of residual: 2.43686e-16



  
    
      Steady State
    
  
  
    
      
    
  




Run 2: increase velocity to 1000, GMRES does not converge anymore

$ ./convdiff --velocity 1000 | tail -n 3
Time required for first solve:  0.47337 (s)
Final L2 norm of residual: 0.00095



  
  
  How many orders of magnitude different is L2 norm of the residual as compared to the previous run?

  
    
    
      
          Between 12 and 13

      
    
  


Below, we plot behavior of the GMRES method for velocity values in the
range [100,1000] at increments, dv, of 25 and also show an animation
of the solution GMRES gives as velocity increases


  
    
      Solutions @dv=25 in [100,1000]
      Contours of Solution @ vel=1000
    
  
  
    
      
      
    
  



  
    
      Time to Solution
      L2 norm of final residual
    
  
  
    
      
      
    
  



  
  
  What do you think happened?

  
    
    
      
          GMRES method works ok for low velocity values.
           As velocity increases, GMRES method eventually crosses a
           threshold where it can no longer provide a useful result

      
    
  



  
  
  Why does time to solution show smoother transition than L2 norm?

  
    
    
      
          As instability is approached, more GMRES iterations are required to
           reach desired norm. So GMRES is still able to manage the solve and
           achieve a near-zero L2 norm. It just takes more and more iterations.
           Once GMRES is unable to solve the L2 norm explodes.

      
    
  




Run 3: Now use SuperLU_DIST, with “natural ordering”
$  ./convdiff --velocity 1000 -slu -cp 0  
Options used:
   --refine 0
   --order 1
   --velocity 1000
   --no-visit
   --superlu
   --slu-colperm 0
   --slu-rowperm 1
   --slu-parsymbfact 0
   --one-matrix
   --one-rhs
Number of unknowns: 10201
	Nonzeros in L       1040781
	Nonzeros in U       1045632
	nonzeros in L+U     2076212
	nonzeros in LSUB    1040215

** Memory Usage **********************************
** NUMfact space (MB): (sum-of-all-processes)
    L\U :           41.12 |  Total :    50.74
** Total highmark (MB):
    Sum-of-all :    50.74 | Avg :    50.74  | Max :    50.74
**************************************************
Time required for first solve:  19.0018 (s)
Final L2 norm of residual: 1.62703e-18

**************************************************
**** Time (seconds) ****
	EQUIL time             0.00
	ROWPERM time           0.01
	SYMBFACT time          0.04
	DISTRIBUTE time        0.11
	FACTOR time           18.52
	Factor flops	1.958603e+08	Mflops 	   10.58
	SOLVE time             0.10
	Solve flops	5.167045e+06	Mflops 	   52.21
	REFINEMENT time        0.20	Steps       2

**************************************************



  
    
      Stead State For vel=1000
    
  
  
    
      
    
  


Run 4: Now use SuperLU_DIST, with MMD(A’+A) ordering.
$ ./convdiff --velocity 1000 -slu -cp 2
Options used:
   --refine 0
   --order 1
   --velocity 1000
   --no-visit
   --superlu
   --slu-colperm 2
   --slu-rowperm 1
   --slu-parsymbfact 0
   --one-matrix
   --one-rhs
Number of unknowns: 10201
	Nonzeros in L       594238
	Nonzeros in U       580425
	nonzeros in L+U     1164462
	nonzeros in LSUB    203857

** Memory Usage **********************************
** NUMfact space (MB): (sum-of-all-processes)
    L\U :           10.07 |  Total :    15.52
** Total highmark (MB):
    Sum-of-all :    15.52 | Avg :    15.52  | Max :    15.52
**************************************************
Time required for first solve:  0.111105 (s)
Final L2 norm of residual: 1.53726e-18

**************************************************
**** Time (seconds) ****
	EQUIL time             0.00
	ROWPERM time           0.01
	COLPERM time           0.04
	SYMBFACT time          0.01
	DISTRIBUTE time        0.02
	FACTOR time            0.05
	Factor flops	1.063303e+08	Mflops 	 2045.75
	SOLVE time             0.00
	Solve flops	2.367059e+06	Mflops 	  779.35
	REFINEMENT time        0.01	Steps       2

**************************************************

NOTE: the number of nonzeros in L+U is much smaller than natural ordering.
This affects the memory usage and runtime.

Run 5: Now use SuperLU_DIST, with Metis(A’+A) ordering.
$ ./convdiff --velocity 1000 -slu -cp 4
Options used:
   --refine 0
   --order 1
   --velocity 1000
   --no-visit
   --superlu
   --slu-colperm 4
   --slu-rowperm 1
   --slu-parsymbfact 0
   --one-matrix
   --one-rhs
Number of unknowns: 10201
	Nonzeros in L       522306
	Nonzeros in U       527748
	nonzeros in L+U     1039853
	nonzeros in LSUB    218211

** Memory Usage **********************************
** NUMfact space (MB): (sum-of-all-processes)
    L\U :            9.24 |  Total :    14.96
** Total highmark (MB):
    Sum-of-all :    14.96 | Avg :    14.96  | Max :    14.96
**************************************************
Time required for first solve:  0.152424 (s)
Final L2 norm of residual: 1.51089e-18

**************************************************
**** Time (seconds) ****
	EQUIL time             0.00
	ROWPERM time           0.01
	COLPERM time           0.05
	SYMBFACT time          0.01
	DISTRIBUTE time        0.02
	FACTOR time            0.05
	Factor flops	7.827314e+07	Mflops 	 1717.18
	SOLVE time             0.00
	Solve flops	2.120276e+06	Mflops 	  606.75
	REFINEMENT time        0.01	Steps       2

**************************************************



  
    
      Solutions @dv=25 in [100,1000]
      Steady State Solution @ vel=1000
    
  
  
    
      
      
    
  


Run 5.5: Now use SuperLU_DIST, with Metis(A’+A) ordering, using 1 MPI tasks, on a larger problem.
By adding --refine 3, each element in the mesh is subdivided twice yielding a 64x larger problem.
But, we’ll run it on only one processor.

$ mpiexec -n 1 ./convdiff --refine 3 --velocity 1000 -slu -cp 4
Options used:
   --refine 3
   --order 1
   --velocity 1000
   --no-visit
   --superlu
   --slu-colperm 4
   --slu-rowperm 1
   --slu-parsymbfact 0
   --one-matrix
   --one-rhs
Number of unknowns: 641601
	Nonzeros in L       40412796
	Nonzeros in U       40412796
	nonzeros in L+U     80183991
	nonzeros in LSUB    15748820

** Memory Usage **********************************
** NUMfact space (MB): (sum-of-all-processes)
    L\U :          701.82 |  Total :   758.92
** Total highmark (MB):
    Sum-of-all :   786.78 | Avg :   786.78  | Max :   786.78
**************************************************
Time required for first solve:  18.8951 (s)
Final L2 norm of residual: 5.99013e-18

**************************************************
**** Time (seconds) ****
	EQUIL time             0.03
	ROWPERM time           0.29
	COLPERM time           4.83
	SYMBFACT time          0.32
	DISTRIBUTE time        1.58
	FACTOR time            9.87
	Factor flops	2.326266e+10	Mflops 	 2357.24
	SOLVE time             0.41
	Solve flops	1.604473e+08	Mflops 	  395.95
	REFINEMENT time        0.90	Steps       2
**************************************************


Run 6: Now use SuperLU_DIST, with Metis(A’+A) ordering, using 16 MPI tasks, on a larger problem.

Here, we’ll re-run the above except on 16 tasks and just grep the output form some key values of interest.

$ ${MPIEXEC_OMPI} -n 16 ./convdiff --refine 3 --velocity 1000 -slu --slu-colperm 4 &amp;gt;&amp;amp; run6.out
Options used:
   --refine 3
   --order 1
   --velocity 1000
   --no-visit
   --superlu
   --slu-colperm 4
   --slu-rowperm 1
   --slu-parsymbfact 0
   --one-matrix
   --one-rhs
Number of unknowns: 641601
	Nonzeros in L       40340620
	Nonzeros in U       40340620
	nonzeros in L+U     80039639
	nonzeros in LSUB    15901421

** Memory Usage **********************************
** NUMfact space (MB): (sum-of-all-processes)
    L\U :          705.31 |  Total :   974.93
** Total highmark (MB):
    Sum-of-all :  2888.58 | Avg :   180.54  | Max :   180.54
**************************************************
Time required for first solve:  9.10544 (s)
Final L2 norm of residual: 2.29801e-39

**************************************************
**** Time (seconds) ****
	EQUIL time             0.03
	ROWPERM time           0.36
	COLPERM time           5.57
	SYMBFACT time          0.37
	DISTRIBUTE time        0.30
	FACTOR time            1.62
	Factor flops	2.301228e+10	Mflops 	14226.55
	SOLVE time             0.14
	Solve flops	1.623936e+08	Mflops 	 1148.60
	REFINEMENT time        0.30	Steps       2



  
  
  Can you explain the processor times relative to
              the previous, single processor run?

  
    
    
      
          We have increased the mesh size by 8x here. The matrix dimension
            goes up as the SQUARE of the mesh size and this accounts for 64x factor
	    of DOFs. We have
            also added 16x processors. The parallel runtime is 9.10544 seconds.

      
    
  


Run 7: Now use SuperLU_DIST, solve the systems with same A, but different right-hand side b.
Here, we solve a different linear system but with the same coefficient matrix A. We tell  SuperLU to re-use the exisiting LU factors, but only give a different right-hand side.
Notice the improvement in solve time when re-using the factors.

$ mpiexec -n 16 ./convdiff --refine 3 --velocity 1000 -slu -cp 4 -2rhs
Options used:
   --refine 3
   --order 1
   --velocity 1000
   --no-visit
   --superlu
   --slu-colperm 4
   --slu-rowperm 1
   --slu-parsymbfact 0
   --one-matrix
   --two-rhs
Number of unknowns: 641601
	Nonzeros in L       40340620
	Nonzeros in U       40340620
	nonzeros in L+U     80039639
	nonzeros in LSUB    15901421

** Memory Usage **********************************
** NUMfact space (MB): (sum-of-all-processes)
    L\U :          705.31 |  Total :   974.93
** Total highmark (MB):
    Sum-of-all :  2888.58 | Avg :   180.54  | Max :   180.54
**************************************************
Time required for first solve:  9.11672 (s)
Final L2 norm of residual: 2.14235e-39

**************************************************
**** Time (seconds) ****
	EQUIL time             0.04
	ROWPERM time           0.36
	COLPERM time           5.64
	SYMBFACT time          0.38
	DISTRIBUTE time        0.23
	FACTOR time            1.61
	Factor flops	2.301228e+10	Mflops 	14307.11
	SOLVE time             0.14
	Solve flops	1.623936e+08	Mflops 	 1147.81
	REFINEMENT time        0.30	Steps       2

**************************************************
Time required for second solve (new rhs):  0.46439 (s)
Final L2 norm of residual: 1.95236e-39

	SOLVE time             0.14
	Solve flops	1.623936e+08	Mflops 	 1202.77
	REFINEMENT time        0.29	Steps       2

**************************************************




Out-Brief

In this lesson, we have used MFEM as a vehicle to demonstrate
the value of direct solvers from the SuperLU_DIST
numerical package.

Further Reading

To learn more about sparse direct solver, see Gene Golub SIAM Summer School
course materials:
Lecture Notes,
Book Chapter, and
Video">
	<meta property="og:url" content="http://localhost:4000/lessons/superlu_mfem/">
	<meta property="og:locale" content="en_EN">
	<meta property="og:type" content="website">
	<meta property="og:site_name" content="ATPESC 2018 Math Library Hands On Exercises">
	
	<meta property="article:author" content="https://www.facebook.com/phlow.media">


	
	<!-- Twitter -->
	<meta name="twitter:card" content="summary">
	<meta name="twitter:site" content="phlow">
	<meta name="twitter:creator" content="phlow">
	<meta name="twitter:title" content="Sparse, Direct Solvers">
	<meta name="twitter:description" content="At A Glance


  
    
      Questions
      Objectives
      Key Points
    
    
      1. Why use a direct solver?
      Understand accuracy
      Direct solvers are robustfor difficult problems
    
    
      2. What effects direct solve performance ?
      Understand ordering options
      Time &amp;amp; space performancecan vary a lot.
    
  


To begin this lesson


  Open the Answers Form
  Get into the correct directory
    cd HandsOnLessons/superlu_mfem
    
    The problem being solved
  


The convdiff.c
application is modeling the steady state convection-diffusion equation in 2D
with a constant velocity.  This equation is used to model the concentration
of something like a die in a moving fluid as it diffuses and flows through
he fluid.  The equation is as follows:



Where u is the concentration that we are tracking, , is the diffusion rate,
v is the velocity of the flow and R is a concentration source.

In the application we use here, the velocity vector direction is fixed in the +x
direction. However, the magnitude is set by the user (default of 100), ,
is fixed at 1.0, and the source is 0.0 everywhere except for a small square centered at
the middle of the domain where it is 1.0.


  
    
      Initial Condition
    
  
  
    
      
    
  


Solving this PDE is well known to cause convergence problems for iterative solvers,
for larger v. We use MFEM as a vehicle to demonstrate the use of a distributed,
direct solver, SuperLU_DIST,
to solve very ill-conditioned linear systems.

Running the Example

Run 1: default setting with GMRES solver, preconditioned by hypre, velocity = 100

$ ./convdiff | tail -n 3
Time required for first solve:  0.0408995 (s)
Final L2 norm of residual: 2.43686e-16



  
    
      Steady State
    
  
  
    
      
    
  




Run 2: increase velocity to 1000, GMRES does not converge anymore

$ ./convdiff --velocity 1000 | tail -n 3
Time required for first solve:  0.47337 (s)
Final L2 norm of residual: 0.00095



  
  
  How many orders of magnitude different is L2 norm of the residual as compared to the previous run?

  
    
    
      
          Between 12 and 13

      
    
  


Below, we plot behavior of the GMRES method for velocity values in the
range [100,1000] at increments, dv, of 25 and also show an animation
of the solution GMRES gives as velocity increases


  
    
      Solutions @dv=25 in [100,1000]
      Contours of Solution @ vel=1000
    
  
  
    
      
      
    
  



  
    
      Time to Solution
      L2 norm of final residual
    
  
  
    
      
      
    
  



  
  
  What do you think happened?

  
    
    
      
          GMRES method works ok for low velocity values.
           As velocity increases, GMRES method eventually crosses a
           threshold where it can no longer provide a useful result

      
    
  



  
  
  Why does time to solution show smoother transition than L2 norm?

  
    
    
      
          As instability is approached, more GMRES iterations are required to
           reach desired norm. So GMRES is still able to manage the solve and
           achieve a near-zero L2 norm. It just takes more and more iterations.
           Once GMRES is unable to solve the L2 norm explodes.

      
    
  




Run 3: Now use SuperLU_DIST, with “natural ordering”
$  ./convdiff --velocity 1000 -slu -cp 0  
Options used:
   --refine 0
   --order 1
   --velocity 1000
   --no-visit
   --superlu
   --slu-colperm 0
   --slu-rowperm 1
   --slu-parsymbfact 0
   --one-matrix
   --one-rhs
Number of unknowns: 10201
	Nonzeros in L       1040781
	Nonzeros in U       1045632
	nonzeros in L+U     2076212
	nonzeros in LSUB    1040215

** Memory Usage **********************************
** NUMfact space (MB): (sum-of-all-processes)
    L\U :           41.12 |  Total :    50.74
** Total highmark (MB):
    Sum-of-all :    50.74 | Avg :    50.74  | Max :    50.74
**************************************************
Time required for first solve:  19.0018 (s)
Final L2 norm of residual: 1.62703e-18

**************************************************
**** Time (seconds) ****
	EQUIL time             0.00
	ROWPERM time           0.01
	SYMBFACT time          0.04
	DISTRIBUTE time        0.11
	FACTOR time           18.52
	Factor flops	1.958603e+08	Mflops 	   10.58
	SOLVE time             0.10
	Solve flops	5.167045e+06	Mflops 	   52.21
	REFINEMENT time        0.20	Steps       2

**************************************************



  
    
      Stead State For vel=1000
    
  
  
    
      
    
  


Run 4: Now use SuperLU_DIST, with MMD(A’+A) ordering.
$ ./convdiff --velocity 1000 -slu -cp 2
Options used:
   --refine 0
   --order 1
   --velocity 1000
   --no-visit
   --superlu
   --slu-colperm 2
   --slu-rowperm 1
   --slu-parsymbfact 0
   --one-matrix
   --one-rhs
Number of unknowns: 10201
	Nonzeros in L       594238
	Nonzeros in U       580425
	nonzeros in L+U     1164462
	nonzeros in LSUB    203857

** Memory Usage **********************************
** NUMfact space (MB): (sum-of-all-processes)
    L\U :           10.07 |  Total :    15.52
** Total highmark (MB):
    Sum-of-all :    15.52 | Avg :    15.52  | Max :    15.52
**************************************************
Time required for first solve:  0.111105 (s)
Final L2 norm of residual: 1.53726e-18

**************************************************
**** Time (seconds) ****
	EQUIL time             0.00
	ROWPERM time           0.01
	COLPERM time           0.04
	SYMBFACT time          0.01
	DISTRIBUTE time        0.02
	FACTOR time            0.05
	Factor flops	1.063303e+08	Mflops 	 2045.75
	SOLVE time             0.00
	Solve flops	2.367059e+06	Mflops 	  779.35
	REFINEMENT time        0.01	Steps       2

**************************************************

NOTE: the number of nonzeros in L+U is much smaller than natural ordering.
This affects the memory usage and runtime.

Run 5: Now use SuperLU_DIST, with Metis(A’+A) ordering.
$ ./convdiff --velocity 1000 -slu -cp 4
Options used:
   --refine 0
   --order 1
   --velocity 1000
   --no-visit
   --superlu
   --slu-colperm 4
   --slu-rowperm 1
   --slu-parsymbfact 0
   --one-matrix
   --one-rhs
Number of unknowns: 10201
	Nonzeros in L       522306
	Nonzeros in U       527748
	nonzeros in L+U     1039853
	nonzeros in LSUB    218211

** Memory Usage **********************************
** NUMfact space (MB): (sum-of-all-processes)
    L\U :            9.24 |  Total :    14.96
** Total highmark (MB):
    Sum-of-all :    14.96 | Avg :    14.96  | Max :    14.96
**************************************************
Time required for first solve:  0.152424 (s)
Final L2 norm of residual: 1.51089e-18

**************************************************
**** Time (seconds) ****
	EQUIL time             0.00
	ROWPERM time           0.01
	COLPERM time           0.05
	SYMBFACT time          0.01
	DISTRIBUTE time        0.02
	FACTOR time            0.05
	Factor flops	7.827314e+07	Mflops 	 1717.18
	SOLVE time             0.00
	Solve flops	2.120276e+06	Mflops 	  606.75
	REFINEMENT time        0.01	Steps       2

**************************************************



  
    
      Solutions @dv=25 in [100,1000]
      Steady State Solution @ vel=1000
    
  
  
    
      
      
    
  


Run 5.5: Now use SuperLU_DIST, with Metis(A’+A) ordering, using 1 MPI tasks, on a larger problem.
By adding --refine 3, each element in the mesh is subdivided twice yielding a 64x larger problem.
But, we’ll run it on only one processor.

$ mpiexec -n 1 ./convdiff --refine 3 --velocity 1000 -slu -cp 4
Options used:
   --refine 3
   --order 1
   --velocity 1000
   --no-visit
   --superlu
   --slu-colperm 4
   --slu-rowperm 1
   --slu-parsymbfact 0
   --one-matrix
   --one-rhs
Number of unknowns: 641601
	Nonzeros in L       40412796
	Nonzeros in U       40412796
	nonzeros in L+U     80183991
	nonzeros in LSUB    15748820

** Memory Usage **********************************
** NUMfact space (MB): (sum-of-all-processes)
    L\U :          701.82 |  Total :   758.92
** Total highmark (MB):
    Sum-of-all :   786.78 | Avg :   786.78  | Max :   786.78
**************************************************
Time required for first solve:  18.8951 (s)
Final L2 norm of residual: 5.99013e-18

**************************************************
**** Time (seconds) ****
	EQUIL time             0.03
	ROWPERM time           0.29
	COLPERM time           4.83
	SYMBFACT time          0.32
	DISTRIBUTE time        1.58
	FACTOR time            9.87
	Factor flops	2.326266e+10	Mflops 	 2357.24
	SOLVE time             0.41
	Solve flops	1.604473e+08	Mflops 	  395.95
	REFINEMENT time        0.90	Steps       2
**************************************************


Run 6: Now use SuperLU_DIST, with Metis(A’+A) ordering, using 16 MPI tasks, on a larger problem.

Here, we’ll re-run the above except on 16 tasks and just grep the output form some key values of interest.

$ ${MPIEXEC_OMPI} -n 16 ./convdiff --refine 3 --velocity 1000 -slu --slu-colperm 4 &amp;gt;&amp;amp; run6.out
Options used:
   --refine 3
   --order 1
   --velocity 1000
   --no-visit
   --superlu
   --slu-colperm 4
   --slu-rowperm 1
   --slu-parsymbfact 0
   --one-matrix
   --one-rhs
Number of unknowns: 641601
	Nonzeros in L       40340620
	Nonzeros in U       40340620
	nonzeros in L+U     80039639
	nonzeros in LSUB    15901421

** Memory Usage **********************************
** NUMfact space (MB): (sum-of-all-processes)
    L\U :          705.31 |  Total :   974.93
** Total highmark (MB):
    Sum-of-all :  2888.58 | Avg :   180.54  | Max :   180.54
**************************************************
Time required for first solve:  9.10544 (s)
Final L2 norm of residual: 2.29801e-39

**************************************************
**** Time (seconds) ****
	EQUIL time             0.03
	ROWPERM time           0.36
	COLPERM time           5.57
	SYMBFACT time          0.37
	DISTRIBUTE time        0.30
	FACTOR time            1.62
	Factor flops	2.301228e+10	Mflops 	14226.55
	SOLVE time             0.14
	Solve flops	1.623936e+08	Mflops 	 1148.60
	REFINEMENT time        0.30	Steps       2



  
  
  Can you explain the processor times relative to
              the previous, single processor run?

  
    
    
      
          We have increased the mesh size by 8x here. The matrix dimension
            goes up as the SQUARE of the mesh size and this accounts for 64x factor
	    of DOFs. We have
            also added 16x processors. The parallel runtime is 9.10544 seconds.

      
    
  


Run 7: Now use SuperLU_DIST, solve the systems with same A, but different right-hand side b.
Here, we solve a different linear system but with the same coefficient matrix A. We tell  SuperLU to re-use the exisiting LU factors, but only give a different right-hand side.
Notice the improvement in solve time when re-using the factors.

$ mpiexec -n 16 ./convdiff --refine 3 --velocity 1000 -slu -cp 4 -2rhs
Options used:
   --refine 3
   --order 1
   --velocity 1000
   --no-visit
   --superlu
   --slu-colperm 4
   --slu-rowperm 1
   --slu-parsymbfact 0
   --one-matrix
   --two-rhs
Number of unknowns: 641601
	Nonzeros in L       40340620
	Nonzeros in U       40340620
	nonzeros in L+U     80039639
	nonzeros in LSUB    15901421

** Memory Usage **********************************
** NUMfact space (MB): (sum-of-all-processes)
    L\U :          705.31 |  Total :   974.93
** Total highmark (MB):
    Sum-of-all :  2888.58 | Avg :   180.54  | Max :   180.54
**************************************************
Time required for first solve:  9.11672 (s)
Final L2 norm of residual: 2.14235e-39

**************************************************
**** Time (seconds) ****
	EQUIL time             0.04
	ROWPERM time           0.36
	COLPERM time           5.64
	SYMBFACT time          0.38
	DISTRIBUTE time        0.23
	FACTOR time            1.61
	Factor flops	2.301228e+10	Mflops 	14307.11
	SOLVE time             0.14
	Solve flops	1.623936e+08	Mflops 	 1147.81
	REFINEMENT time        0.30	Steps       2

**************************************************
Time required for second solve (new rhs):  0.46439 (s)
Final L2 norm of residual: 1.95236e-39

	SOLVE time             0.14
	Solve flops	1.623936e+08	Mflops 	 1202.77
	REFINEMENT time        0.29	Steps       2

**************************************************




Out-Brief

In this lesson, we have used MFEM as a vehicle to demonstrate
the value of direct solvers from the SuperLU_DIST
numerical package.

Further Reading

To learn more about sparse direct solver, see Gene Golub SIAM Summer School
course materials:
Lecture Notes,
Book Chapter, and
Video">
	
	

	<link type="text/plain" rel="author" href="http://localhost:4000/humans.txt">

	

	

	<link rel="icon" sizes="32x32" href="http://localhost:4000/assets/img/favicon-32x32.png">

	<link rel="icon" sizes="192x192" href="http://localhost:4000/assets/img/touch-icon-192x192.png">

	<link rel="apple-touch-icon-precomposed" sizes="180x180" href="http://localhost:4000/assets/img/apple-touch-icon-180x180-precomposed.png">

	<link rel="apple-touch-icon-precomposed" sizes="152x152" href="http://localhost:4000/assets/img/apple-touch-icon-152x152-precomposed.png">

	<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://localhost:4000/assets/img/apple-touch-icon-144x144-precomposed.png">

	<link rel="apple-touch-icon-precomposed" sizes="120x120" href="http://localhost:4000/assets/img/apple-touch-icon-120x120-precomposed.png">

	<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://localhost:4000/assets/img/apple-touch-icon-114x114-precomposed.png">

	
	<link rel="apple-touch-icon-precomposed" sizes="76x76" href="http://localhost:4000/assets/img/apple-touch-icon-76x76-precomposed.png">

	<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://localhost:4000/assets/img/apple-touch-icon-72x72-precomposed.png">

	<link rel="apple-touch-icon-precomposed" href="http://localhost:4000/assets/img/apple-touch-icon-precomposed.png">	

	<meta name="msapplication-TileImage" content="http://localhost:4000/assets/img/msapplication_tileimage.png">

	<meta name="msapplication-TileColor" content="#fabb00">


	

        
	   <!-- MathJax Config
                    CommonHTML: {
                        scale: 200
                    }
            <script type="text/x-mathjax-config">
                MathJax.Hub.Config({
                    displayAlign: "left"
                });
            </script>
            -->
            <script type="text/javascript" async
                src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML" async>
            </script>
            <script type="text/x-mathjax-config">
                MathJax.Hub.Config({
                    TeX: { 
                        equationNumbers: {  autoNumber: "all"  }
                    }
                });
            </script>
        

</head>
<body id="top-of-page" class="page-fullwidth">
        

	
	
<div id="navigation" class="sticky">
  <nav class="top-bar" role="navigation" data-topbar>
    <ul class="title-area">
      <li class="name">
      <h1 class="show-for-small-only"><a href="http://localhost:4000" class="icon-tree"> ATPESC 2018 Math Library Hands On Exercises</a></h1>
    </li>
       <!-- Remove the class "menu-icon" to get rid of menu icon. Take out "Menu" to just have icon alone -->
      <li class="toggle-topbar menu-icon"><a href="#"><span>Nav</span></a></li>
    </ul>
    <section class="top-bar-section">

      <ul class="right">
        
              

              

          
          
        
              

              

          
          
        
              

              

          
          
        
              

              

          
          
        
        
      </ul>

      <ul class="left">
        
              

              

          
          

            
            

              <li class="has-dropdown">
                <a  href="http://localhost:4000/">Intro</a>

                  <ul class="dropdown">
                    

                      

                      <li><a  href="http://localhost:4000/about_your_day/">About Your Day</a></li>
                    

                      

                      <li><a  href="http://localhost:4000/setup_instructions/">Setup Instructions</a></li>
                    

                      

                      <li><a  href="http://localhost:4000/atpesc_2018_agenda/">Today&#39;s Agenda</a></li>
                    

                      

                      <li><a  href="https://www.alcf.anl.gov/user-guides" target="_blank">ALCF User Guides</a></li>
                    

                      

                      <li><a  href="https://hangouts.google.com/group/wuWDDdPe4mX1u0v83" target="_blank">Open Chat</a></li>
                    

                      

                      <li><a  href="http://localhost:4000/pages/one_on_one_schedule.html">One-on-One Schedule</a></li>
                    

                      

                      <li><a  href="https://goo.gl/forms/B7UFpBvEOJbC58oJ2" target="_blank">Submit a Show Your Work</a></li>
                    
                  </ul>

              </li>
              <li class="divider"></li>
            
          
        
              

              

          
          

            
            

              <li class="has-dropdown">
                <a  href="http://localhost:4000/lessons/">Lessons</a>

                  <ul class="dropdown">
                    

                      

                      <li><a  href="http://localhost:4000/lessons/hand_coded_heat/">Hand Coded Heat</a></li>
                    

                      

                      <li><a  href="http://localhost:4000/lessons/mfem_convergence/">Meshing and Discretization (MFEM)</a></li>
                    

                      

                      <li><a  href="http://localhost:4000/lessons/pumi/">MFEM+PUMI Adaptive Workflow</a></li>
                    

                      

                      <li><a  href="http://localhost:4000/lessons/time_integrators/">Time Integration &amp; Non-Linear Solvers</a></li>
                    

                      

                      <li><a  href="http://localhost:4000/lessons/krylov_amg/">Krylov Solvers and Algebraic Multigrid</a></li>
                    

                      

                      <li><a  href="http://localhost:4000/lessons/superlu_mfem/">Sparse Direct Solvers</a></li>
                    

                      

                      <li><a  href="http://localhost:4000/lessons/adjoint/">Numerical Optimization (Adjoint)</a></li>
                    

                      

                      <li><a  href="http://localhost:4000/lessons/obstacle_tao">Numerical Optimization</a></li>
                    
                  </ul>

              </li>
              <li class="divider"></li>
            
          
        
              

              

          
          

            
            

              <li class="has-dropdown">
                <a  href="https://fastmath-scidac.org/software-catalog.html" target="_blank">Packages</a>

                  <ul class="dropdown">
                    

                      

                      <li><a  href="http://mfem.org" target="_blank">MFEM</a></li>
                    

                      

                      <li><a  href="https://www.scorec.rpi.edu/pumi" target="_blank">PUMI</a></li>
                    

                      

                      <li><a  href="https://www.mcs.anl.gov/petsc/" target="_blank">PETSc</a></li>
                    

                      

                      <li><a  href="https://computation.llnl.gov/projects/hypre-scalable-linear-solvers-multigrid-methods" target="_blank">HYPRE</a></li>
                    

                      

                      <li><a  href="http://crd-legacy.lbl.gov/~xiaoye/SuperLU" target="_blank">SuperLU</a></li>
                    

                      

                      <li><a  href="http://www.mcs.anl.gov/research/projects/tao/tao-deprecated/index.html" target="_blank">Tao</a></li>
                    
                  </ul>

              </li>
              <li class="divider"></li>
            
          
        
              

              

          
          

            
            

              <li class="has-dropdown">
                <a  href="http://localhost:4000/contributing_guide/">Contributing</a>

                  <ul class="dropdown">
                    

                      

                      <li><a  href="http://localhost:4000/contributing_guide/">Contributing Guide</a></li>
                    

                      

                      <li><a  href="http://localhost:4000/info/">Why the new theme?</a></li>
                    

                      

                      <li><a  href="http://localhost:4000/headers/">Many Header Styles</a></li>
                    

                      

                      <li><a  href="http://localhost:4000/design/">Many Design Options</a></li>
                    

                      

                      <li><a  href="http://localhost:4000/documentation/">Full Documentation</a></li>
                    
                  </ul>

              </li>
              <li class="divider"></li>
            
          
        
        
      </ul>
    </section>
  </nav>
</div><!-- /#navigation -->

	

	

<div id="masthead">
	<div class="row">
		<div class="small-12 columns">
			<a id="logo" href="http://localhost:4000/" title="ATPESC 2018 Math Library Hands On Exercises – So my code will see the future">
				<img src="http://localhost:4000/assets/img/logo.png" alt="ATPESC 2018 Math Library Hands On Exercises – So my code will see the future">
			</a>
		</div><!-- /.small-12.columns -->
	</div><!-- /.row -->
</div><!-- /#masthead -->










	


<div class="row t30">
	<div class="medium-12 columns">
		<article>
			<header>
				<p class="subheadline">Role and Use of Direct Solvers in Ill-Conditioned Problems</p>
				<h1>Sparse, Direct Solvers</h1>
			</header>

			

			<h2 id="at-a-glance">At A Glance</h2>

<table>
  <tbody>
    <tr>
      <td>Questions</td>
      <td>Objectives</td>
      <td>Key Points</td>
    </tr>
    <tr>
      <td>1. Why use a direct solver?</td>
      <td>Understand accuracy</td>
      <td>Direct solvers are robust<br />for difficult problems</td>
    </tr>
    <tr>
      <td>2. What effects direct solve performance ?</td>
      <td>Understand ordering options</td>
      <td>Time &amp; space performance<br />can vary a lot.</td>
    </tr>
  </tbody>
</table>

<h2 id="to-begin-this-lesson">To begin this lesson</h2>

<ul>
  <li><a href="https://docs.google.com/forms/d/e/1FAIpQLSfxlKXG74hffseYxc52l7p7DALHk-WTiZXQmdT6WGMVBRw7Sg/viewform?usp=sf_link" target="_blank">Open the Answers Form</a></li>
  <li>Get into the correct directory
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd HandsOnLessons/superlu_mfem
</code></pre></div>    </div>
    <h2 id="the-problem-being-solved">The problem being solved</h2>
  </li>
</ul>

<p>The <a href="https://github.com/mfem/mfem/blob/atpesc-dev/examples/atpesc/superlu/convdiff.cpp">convdiff.c</a>
application is modeling the steady state convection-diffusion equation in 2D
with a constant velocity.  This equation is used to model the concentration
of something like a <em>die</em> in a <em>moving</em> fluid as it diffuses and flows through
he fluid.  The equation is as follows:</p>

<script type="math/tex; mode=display">\nabla \cdot (\kappa \nabla u) - \nabla \cdot (\overrightarrow{v}u)+R=0</script>

<p>Where <em>u</em> is the concentration that we are tracking, <script type="math/tex">\kappa</script>, is the diffusion rate,
<em>v</em> is the velocity of the flow and <em>R</em> is a concentration source.</p>

<p>In the application we use here, the velocity vector <em>direction</em> is fixed in the <em>+x</em>
direction. However, the <em>magnitude</em> is set by the user (default of 100), <script type="math/tex">\kappa</script>,
is fixed at 1.0, and the source is 0.0 everywhere except for a small square centered at
the middle of the domain where it is 1.0.</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">Initial Condition</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><a href="/lessons/superlu_mfem/mfem-superlu0000.png"><img src="mfem-superlu0000.png" width="400" /></a></td>
    </tr>
  </tbody>
</table>

<p>Solving this PDE is well known to cause convergence problems for iterative solvers,
for larger <em>v</em>. We use MFEM as a vehicle to demonstrate the use of a distributed,
direct solver, <a href="http://crd-legacy.lbl.gov/~xiaoye/SuperLU/">SuperLU_DIST</a>,
to solve very ill-conditioned linear systems.</p>

<h2 id="running-the-example">Running the Example</h2>

<h3 id="run-1-default-setting-with-gmres-solver-preconditioned-by-hypre-velocity--100">Run 1: default setting with GMRES solver, preconditioned by hypre, velocity = 100</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ./convdiff | tail -n 3
Time required for first solve:  0.0408995 (s)
Final L2 norm of residual: 2.43686e-16
</code></pre></div></div>

<table>
  <thead>
    <tr>
      <th style="text-align: center">Steady State</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><a href="/lessons/superlu_mfem/mfem-superlu0005.png"><img src="mfem-superlu0005.png" width="400" /></a></td>
    </tr>
  </tbody>
</table>

<hr />

<h3 id="run-2-increase-velocity-to-1000-gmres-does-not-converge-anymore">Run 2: increase velocity to 1000, GMRES does not converge anymore</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ./convdiff --velocity 1000 | tail -n 3
Time required for first solve:  0.47337 (s)
Final L2 norm of residual: 0.00095
</code></pre></div></div>

<div class="qanda">
  
  <input id="qanda_toggle1" type="checkbox" unchecked="" />
  <label class="qanda" for="qanda_toggle1" style="font-size:150%">How many orders of magnitude different is L2 norm of the residual as compared to the previous run?
</label>
  <div id="qanda_expand1">
    <style>
      #qanda_toggle1:checked ~ #qanda_expand1 {
        
        
        
        
            height: 10vmin;
        
      }
    </style>
    <section>
      
          <p>Between 12 and 13</p>

      
    </section>
  </div>
</div>

<p>Below, we plot behavior of the GMRES method for velocity values in the
range [100,1000] at increments, <em>dv</em>, of 25 and also show an animation
of the solution GMRES gives as velocity increases</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">Solutions @<em>dv</em>=25 in [100,1000]</th>
      <th style="text-align: center">Contours of Solution @ <em>vel=1000</em></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><video src="gmres.mpg" width="400" height="300" controls="" preload=""></video></td>
      <td style="text-align: center"><a href="/lessons/superlu_mfem/mfem-superlu0003.png"><img src="mfem-superlu0003.png" width="400" /></a></td>
    </tr>
  </tbody>
</table>

<table>
  <thead>
    <tr>
      <th style="text-align: center">Time to Solution</th>
      <th style="text-align: center">L2 norm of final residual</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><a href="/lessons/superlu_mfem/gmres_time.png"><img src="gmres_time.png" width="400" /></a></td>
      <td style="text-align: center"><a href="/lessons/superlu_mfem/gmres_residual.png"><img src="gmres_residual.png" width="400" /></a></td>
    </tr>
  </tbody>
</table>

<div class="qanda">
  
  <input id="qanda_toggle2" type="checkbox" unchecked="" />
  <label class="qanda" for="qanda_toggle2" style="font-size:150%">What do you think happened?
</label>
  <div id="qanda_expand2">
    <style>
      #qanda_toggle2:checked ~ #qanda_expand2 {
        
        
        
        
            height: 10vmin;
        
      }
    </style>
    <section>
      
          <p>GMRES method works ok for low velocity values.
           As velocity increases, GMRES method eventually crosses a
           threshold where it can no longer provide a useful result</p>

      
    </section>
  </div>
</div>

<div class="qanda">
  
  <input id="qanda_toggle3" type="checkbox" unchecked="" />
  <label class="qanda" for="qanda_toggle3" style="font-size:150%">Why does time to solution show smoother transition than L2 norm?
</label>
  <div id="qanda_expand3">
    <style>
      #qanda_toggle3:checked ~ #qanda_expand3 {
        
        
        
        
            height: 14vmin;
        
      }
    </style>
    <section>
      
          <p>As instability is approached, more GMRES iterations are required to
           reach desired norm. So GMRES is still able to manage the solve and
           achieve a near-zero L2 norm. It just takes more and more iterations.
           Once GMRES is unable to solve the L2 norm explodes.</p>

      
    </section>
  </div>
</div>

<hr />

<h3 id="run-3-now-use-superlu_dist-with-natural-ordering">Run 3: Now use SuperLU_DIST, with “natural ordering”</h3>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$  ./convdiff --velocity 1000 -slu -cp 0  
Options used:
   --refine 0
   --order 1
   --velocity 1000
   --no-visit
   --superlu
   --slu-colperm 0
   --slu-rowperm 1
   --slu-parsymbfact 0
   --one-matrix
   --one-rhs
Number of unknowns: 10201
	Nonzeros in L       1040781
	Nonzeros in U       1045632
	nonzeros in L+U     2076212
	nonzeros in LSUB    1040215

** Memory Usage **********************************
** NUMfact space (MB): (sum-of-all-processes)
    L\U :           41.12 |  Total :    50.74
** Total highmark (MB):
    Sum-of-all :    50.74 | Avg :    50.74  | Max :    50.74
**************************************************
Time required for first solve:  19.0018 (s)
Final L2 norm of residual: 1.62703e-18

**************************************************
**** Time (seconds) ****
	EQUIL time             0.00
	ROWPERM time           0.01
	SYMBFACT time          0.04
	DISTRIBUTE time        0.11
	FACTOR time           18.52
	Factor flops	1.958603e+08	Mflops 	   10.58
	SOLVE time             0.10
	Solve flops	5.167045e+06	Mflops 	   52.21
	REFINEMENT time        0.20	Steps       2

**************************************************
</code></pre></div></div>

<table>
  <thead>
    <tr>
      <th style="text-align: center">Stead State For <em>vel=1000</em></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><a href="/lessons/superlu_mfem/mfem-superlu0004.png"><img src="mfem-superlu0004.png" width="400" /></a></td>
    </tr>
  </tbody>
</table>

<h3 id="run-4-now-use-superlu_dist-with-mmdaa-ordering">Run 4: Now use SuperLU_DIST, with MMD(A’+A) ordering.</h3>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ./convdiff --velocity 1000 -slu -cp 2
Options used:
   --refine 0
   --order 1
   --velocity 1000
   --no-visit
   --superlu
   --slu-colperm 2
   --slu-rowperm 1
   --slu-parsymbfact 0
   --one-matrix
   --one-rhs
Number of unknowns: 10201
	Nonzeros in L       594238
	Nonzeros in U       580425
	nonzeros in L+U     1164462
	nonzeros in LSUB    203857

** Memory Usage **********************************
** NUMfact space (MB): (sum-of-all-processes)
    L\U :           10.07 |  Total :    15.52
** Total highmark (MB):
    Sum-of-all :    15.52 | Avg :    15.52  | Max :    15.52
**************************************************
Time required for first solve:  0.111105 (s)
Final L2 norm of residual: 1.53726e-18

**************************************************
**** Time (seconds) ****
	EQUIL time             0.00
	ROWPERM time           0.01
	COLPERM time           0.04
	SYMBFACT time          0.01
	DISTRIBUTE time        0.02
	FACTOR time            0.05
	Factor flops	1.063303e+08	Mflops 	 2045.75
	SOLVE time             0.00
	Solve flops	2.367059e+06	Mflops 	  779.35
	REFINEMENT time        0.01	Steps       2

**************************************************
</code></pre></div></div>
<p>NOTE: the number of nonzeros in L+U is much smaller than natural ordering.
This affects the memory usage and runtime.</p>

<h3 id="run-5-now-use-superlu_dist-with-metisaa-ordering">Run 5: Now use SuperLU_DIST, with Metis(A’+A) ordering.</h3>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ./convdiff --velocity 1000 -slu -cp 4
Options used:
   --refine 0
   --order 1
   --velocity 1000
   --no-visit
   --superlu
   --slu-colperm 4
   --slu-rowperm 1
   --slu-parsymbfact 0
   --one-matrix
   --one-rhs
Number of unknowns: 10201
	Nonzeros in L       522306
	Nonzeros in U       527748
	nonzeros in L+U     1039853
	nonzeros in LSUB    218211

** Memory Usage **********************************
** NUMfact space (MB): (sum-of-all-processes)
    L\U :            9.24 |  Total :    14.96
** Total highmark (MB):
    Sum-of-all :    14.96 | Avg :    14.96  | Max :    14.96
**************************************************
Time required for first solve:  0.152424 (s)
Final L2 norm of residual: 1.51089e-18

**************************************************
**** Time (seconds) ****
	EQUIL time             0.00
	ROWPERM time           0.01
	COLPERM time           0.05
	SYMBFACT time          0.01
	DISTRIBUTE time        0.02
	FACTOR time            0.05
	Factor flops	7.827314e+07	Mflops 	 1717.18
	SOLVE time             0.00
	Solve flops	2.120276e+06	Mflops 	  606.75
	REFINEMENT time        0.01	Steps       2

**************************************************
</code></pre></div></div>

<table>
  <thead>
    <tr>
      <th style="text-align: center">Solutions @<em>dv</em>=25 in [100,1000]</th>
      <th style="text-align: center">Steady State Solution @ <em>vel=1000</em></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><video src="slu_metis.mpg" width="400" height="300" controls="" preload=""></video></td>
      <td style="text-align: center"><a href="/lessons/superlu_mfem/mfem-superlu0004.png"><img src="mfem-superlu0004.png" width="400" /></a></td>
    </tr>
  </tbody>
</table>

<h3 id="run-55-now-use-superlu_dist-with-metisaa-ordering-using-1-mpi-tasks-on-a-larger-problem">Run 5.5: Now use SuperLU_DIST, with Metis(A’+A) ordering, using 1 MPI tasks, on a larger problem.</h3>
<p>By adding <code class="highlighter-rouge">--refine 3</code>, each element in the mesh is subdivided twice yielding a 64x larger problem.
But, we’ll run it on only one processor.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ mpiexec -n 1 ./convdiff --refine 3 --velocity 1000 -slu -cp 4
Options used:
   --refine 3
   --order 1
   --velocity 1000
   --no-visit
   --superlu
   --slu-colperm 4
   --slu-rowperm 1
   --slu-parsymbfact 0
   --one-matrix
   --one-rhs
Number of unknowns: 641601
	Nonzeros in L       40412796
	Nonzeros in U       40412796
	nonzeros in L+U     80183991
	nonzeros in LSUB    15748820

** Memory Usage **********************************
** NUMfact space (MB): (sum-of-all-processes)
    L\U :          701.82 |  Total :   758.92
** Total highmark (MB):
    Sum-of-all :   786.78 | Avg :   786.78  | Max :   786.78
**************************************************
Time required for first solve:  18.8951 (s)
Final L2 norm of residual: 5.99013e-18

**************************************************
**** Time (seconds) ****
	EQUIL time             0.03
	ROWPERM time           0.29
	COLPERM time           4.83
	SYMBFACT time          0.32
	DISTRIBUTE time        1.58
	FACTOR time            9.87
	Factor flops	2.326266e+10	Mflops 	 2357.24
	SOLVE time             0.41
	Solve flops	1.604473e+08	Mflops 	  395.95
	REFINEMENT time        0.90	Steps       2
**************************************************
</code></pre></div></div>

<h3 id="run-6-now-use-superlu_dist-with-metisaa-ordering-using-16-mpi-tasks-on-a-larger-problem">Run 6: Now use SuperLU_DIST, with Metis(A’+A) ordering, using 16 MPI tasks, on a larger problem.</h3>

<p>Here, we’ll re-run the above except on 16 tasks and just grep the output form some key values of interest.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ${MPIEXEC_OMPI} -n 16 ./convdiff --refine 3 --velocity 1000 -slu --slu-colperm 4 &gt;&amp; run6.out
Options used:
   --refine 3
   --order 1
   --velocity 1000
   --no-visit
   --superlu
   --slu-colperm 4
   --slu-rowperm 1
   --slu-parsymbfact 0
   --one-matrix
   --one-rhs
Number of unknowns: 641601
	Nonzeros in L       40340620
	Nonzeros in U       40340620
	nonzeros in L+U     80039639
	nonzeros in LSUB    15901421

** Memory Usage **********************************
** NUMfact space (MB): (sum-of-all-processes)
    L\U :          705.31 |  Total :   974.93
** Total highmark (MB):
    Sum-of-all :  2888.58 | Avg :   180.54  | Max :   180.54
**************************************************
Time required for first solve:  9.10544 (s)
Final L2 norm of residual: 2.29801e-39

**************************************************
**** Time (seconds) ****
	EQUIL time             0.03
	ROWPERM time           0.36
	COLPERM time           5.57
	SYMBFACT time          0.37
	DISTRIBUTE time        0.30
	FACTOR time            1.62
	Factor flops	2.301228e+10	Mflops 	14226.55
	SOLVE time             0.14
	Solve flops	1.623936e+08	Mflops 	 1148.60
	REFINEMENT time        0.30	Steps       2
</code></pre></div></div>

<div class="qanda">
  
  <input id="qanda_toggle4" type="checkbox" unchecked="" />
  <label class="qanda" for="qanda_toggle4" style="font-size:150%">Can you explain the processor times <em>relative</em> to
              the previous, single processor run?
</label>
  <div id="qanda_expand4">
    <style>
      #qanda_toggle4:checked ~ #qanda_expand4 {
        
        
        
        
            height: 12vmin;
        
      }
    </style>
    <section>
      
          <p>We have increased the mesh size by 8x here. The matrix dimension
            goes up as the SQUARE of the mesh size and this accounts for 64x factor
	    of DOFs. We have
            also added 16x processors. The parallel runtime is 9.10544 seconds.</p>

      
    </section>
  </div>
</div>

<h3 id="run-7-now-use-superlu_dist-solve-the-systems-with-same-a-but-different-right-hand-side-b">Run 7: Now use SuperLU_DIST, solve the systems with same A, but different right-hand side b.</h3>
<p>Here, we solve a different linear system but with the same coefficient matrix A. We tell  SuperLU to re-use the exisiting LU factors, but only give a different right-hand side.
Notice the improvement in solve time when re-using the factors.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ mpiexec -n 16 ./convdiff --refine 3 --velocity 1000 -slu -cp 4 -2rhs
Options used:
   --refine 3
   --order 1
   --velocity 1000
   --no-visit
   --superlu
   --slu-colperm 4
   --slu-rowperm 1
   --slu-parsymbfact 0
   --one-matrix
   --two-rhs
Number of unknowns: 641601
	Nonzeros in L       40340620
	Nonzeros in U       40340620
	nonzeros in L+U     80039639
	nonzeros in LSUB    15901421

** Memory Usage **********************************
** NUMfact space (MB): (sum-of-all-processes)
    L\U :          705.31 |  Total :   974.93
** Total highmark (MB):
    Sum-of-all :  2888.58 | Avg :   180.54  | Max :   180.54
**************************************************
Time required for first solve:  9.11672 (s)
Final L2 norm of residual: 2.14235e-39

**************************************************
**** Time (seconds) ****
	EQUIL time             0.04
	ROWPERM time           0.36
	COLPERM time           5.64
	SYMBFACT time          0.38
	DISTRIBUTE time        0.23
	FACTOR time            1.61
	Factor flops	2.301228e+10	Mflops 	14307.11
	SOLVE time             0.14
	Solve flops	1.623936e+08	Mflops 	 1147.81
	REFINEMENT time        0.30	Steps       2

**************************************************
Time required for second solve (new rhs):  0.46439 (s)
Final L2 norm of residual: 1.95236e-39

	SOLVE time             0.14
	Solve flops	1.623936e+08	Mflops 	 1202.77
	REFINEMENT time        0.29	Steps       2

**************************************************
</code></pre></div></div>

<hr />

<h2 id="out-brief">Out-Brief</h2>

<p>In this lesson, we have used <a href="http://mfem.org">MFEM</a> as a vehicle to demonstrate
the value of direct solvers from the <a href="http://crd-legacy.lbl.gov/~xiaoye/SuperLU/">SuperLU_DIST</a>
numerical package.</p>

<h3 id="further-reading">Further Reading</h3>

<p>To learn more about sparse direct solver, see Gene Golub SIAM Summer School
course materials:
<a href="http://www.siam.org/students/g2s3/2013/lecturers/XSLi/Lecture-Notes/sherry.pdf">Lecture Notes</a>,
<a href="http://crd-legacy.lbl.gov/~xiaoye/g2s3-summary.pdf">Book Chapter</a>, and
<a href="http://www.siam.org/students/g2s3/2013/course.html">Video</a></p>


                        
                        <p><a href='../../lessons'>Back to all ATPESC 2018 Lessons</a></p>
                        

		</article>
	</div><!-- /.medium-12.columns -->
</div><!-- /.row -->




	
	    <div id="up-to-top" class="row">
      <div class="small-12 columns" style="text-align: right;">
        <a class="iconfont" href="#top-of-page">&#xf108;</a>
      </div><!-- /.small-12.columns -->
    </div><!-- /.row -->


    <footer id="footer-content" class="bg-grau">
      <div id="footer">
        <div class="row">
          <div class="medium-6 large-5 columns">
            <h5 class="shadow-black">About This Site</h5>

            <p class="shadow-black">
              <a href="https://software-carpentry.org">Software Carpentry</a> Style Lessons for Numerical Libraries
              <a href="http://localhost:4000/info/">More ›</a>
              Created by <a href="https://github.com/markcmiller86">Mark C Miller</a> with <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> based on <a href="http://phlow.github.io/feeling-responsive/">Feeling Responsive</a>.</p>
            </p>
          </div><!-- /.large-6.columns -->

          <div class="small-6 medium-3 large-3 columns">
            <ul class="inline-list social-icons">
            
              <li><a href="https://fastmath-scidac.llnl.gov" target="_blank" class="icon-home" title="FASTMath"></a></li>
            
              <li><a href="https://www.youtube.com/playlist?list=PLGj2a3KTwhRZKjI7pRFxQDBORsswJAdJt" target="_blank" class="icon-youtube" title="ATPESC-2017 Numerical Libaries"></a></li>
            
              <li><a href="https://www.youtube.com/channel/UCEkJLPAMOUsjC_RXGFcVq-A/videos" target="_blank" class="icon-youtube" title="IDEAS on YouTube"></a></li>
            
              <li><a href="http://twitter.com/exascaleproject" target="_blank" class="icon-twitter" title="Exascale Project on Twitter"></a></li>
            
            </ul>

                        <a class="button left r15 tiny radius" href="https://github.com/xsdk-project/ATPESC2018HandsOnLessons/edit/gh-pages/_lessons/superlu_mfem/lesson.md">Edit This Page On GitHub</a>



          </div><!-- /.large-3.columns -->
        </div><!-- /.row -->

      </div><!-- /#footer -->

    </footer>

	

	


<script src="http://localhost:4000/assets/js/javascript.min.js"></script>



<script>
    $("#masthead").backstretch("http://localhost:4000/images/matrices.png", {fade: 700});
    $("#masthead-with-text").backstretch("http://localhost:4000/images/matrices.png", {fade: 700});
</script>












</body>
</html>

